#/system/bin/sh
PATH=/sbin:/system/sbin:/system/bin:/system/xbin
PROFILE_PERFORMANCE_FILE="/sdcard/perf_list"
export PATH

function set_little_maxfreq {
    for i in {0,1,2,3}
    do
        echo $1 > /sys/devices/system/cpu/cpu$i/cpufreq/scaling_max_freq
    done
}

#POST BOOT PEAK

echo 4 > /sys/devices/system/cpu/cpu0/core_ctl/max_cpus
echo 4 > /sys/devices/system/cpu/cpu0/core_ctl/min_cpus
echo 4 > /sys/devices/system/cpu/cpu4/core_ctl/max_cpus
echo 1 > /sys/devices/system/cpu/cpu4/core_ctl/min_cpus
set_little_maxfreq 1555200

# Yadi: leave it at maximum performance for a while to boot up
sleep 120

while [ 1 ]
do
    DUMPSYS_POWER=(`dumpsys power | grep -E 'mHoldingDisplaySuspendBlocker|mWakefulness'`)
    mWakefulness=${DUMPSYS_POWER[0]}
    mWakefulnessChanging=${DUMPSYS_POWER[1]}
    mHoldingDisplaySuspendBlocker=${DUMPSYS_POWER[2]}

    # Yadli: condition for enterning low-power mode:
    # screen wakelock is released, and it's not waking up
    # waking up condition:
    # wakefulness is Awake, or wakefulnessChanging is true.

    Awake="."
    if ! [ "$mWakefulness" == "mWakefulness=Awake" ] || [ "$mWakefulnessChanging" == "mWakefulnessChanging=true" ]
    then
        if [ "$mHoldingDisplaySuspendBlocker" == "mHoldingDisplaySuspendBlocker=false" ]
        then
            Awake=""
        fi
    fi

	if [ -z $Awake ]
	then
		#SCREENOFF
		POLL_CYCLE="0.15"
        set_little_maxfreq 672000
		echo 1 > /sys/devices/system/cpu/cpu0/core_ctl/max_cpus
		echo 1 > /sys/devices/system/cpu/cpu0/core_ctl/min_cpus
		echo 0 > /sys/devices/system/cpu/cpu4/core_ctl/max_cpus
		echo 0 > /sys/devices/system/cpu/cpu4/core_ctl/min_cpus
	else
        POLL_CYCLE="20"
        set_little_maxfreq 1555200
		GREP_RESULT=`dumpsys activity activities | grep mFocusedActivity | cut -d ' ' -f 6 | cut -d '/' -f 0 | grep -f $PROFILE_PERFORMANCE_FILE -F`
		if [ -z "$GREP_RESULT" ]
		then
			#POWERSAVE
			echo 3 > /sys/devices/system/cpu/cpu0/core_ctl/max_cpus
			echo 1 > /sys/devices/system/cpu/cpu0/core_ctl/min_cpus
			echo 1 > /sys/devices/system/cpu/cpu4/core_ctl/max_cpus
			echo 0 > /sys/devices/system/cpu/cpu4/core_ctl/min_cpus
		else
			#PERFORMANCE
			echo 4 > /sys/devices/system/cpu/cpu0/core_ctl/max_cpus
			echo 2 > /sys/devices/system/cpu/cpu0/core_ctl/min_cpus
			echo 2 > /sys/devices/system/cpu/cpu4/core_ctl/max_cpus
			echo 1 > /sys/devices/system/cpu/cpu4/core_ctl/min_cpus
		fi
	fi
	sleep $POLL_CYCLE
done
